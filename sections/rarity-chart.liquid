{%- liquid
  assign collection = collections[section.settings.collection] | default: collections.all
  assign products = collection.products
  
  assign secret_count = 0
  assign super_rare_count = 0
  assign rare_count = 0
  
  for product in products
    assign rarity = product.metafields.custom.rarity.value | default: 'Rare'
    if rarity == 'Secret'
      assign secret_count = secret_count | plus: 1
    elsif rarity == 'Super Rare'
      assign super_rare_count = super_rare_count | plus: 1
    else
      assign rare_count = rare_count | plus: 1
    endif
  endfor
  
  assign total = products.size
  assign secret_percentage = 0
  assign super_rare_percentage = 0
  assign rare_percentage = 0
  
  if total > 0
    assign secret_percentage = secret_count | times: 100 | divided_by: total
    assign super_rare_percentage = super_rare_count | times: 100 | divided_by: total
    assign rare_percentage = rare_count | times: 100 | divided_by: total
  endif
-%}

<section class="relative z-20 py-20 px-6 bg-purple-50">
  <div class="max-w-7xl mx-auto">
    <h2 class="text-5xl md:text-7xl font-black mb-12 tracking-tighter">
      {{ section.settings.heading | default: "RARITY" }}
      {%- if section.settings.heading_accent != blank -%}
        <span class="text-purple-400">{{ section.settings.heading_accent }}</span>
      {%- endif -%}
    </h2>
    
    <div class="space-y-8">
      <div>
        <div class="flex justify-between items-center mb-2">
          <span class="text-xl font-bold text-purple-600">SECRET</span>
          <span class="text-sm text-gray-600">{{ secret_count }} items</span>
        </div>
        <div class="h-8 bg-purple-100 rounded-full overflow-hidden">
          <div 
            class="rarity-bar h-full bg-gradient-to-r from-purple-600 to-purple-400 flex items-center justify-end pr-4"
            style="width: {{ secret_percentage }}%"
          >
            <span class="text-xs font-bold text-white">{{ secret_percentage }}%</span>
          </div>
        </div>
      </div>
      
      <div>
        <div class="flex justify-between items-center mb-2">
          <span class="text-xl font-bold text-purple-500">SUPER RARE</span>
          <span class="text-sm text-gray-600">{{ super_rare_count }} items</span>
        </div>
        <div class="h-8 bg-purple-100 rounded-full overflow-hidden">
          <div 
            class="rarity-bar h-full bg-gradient-to-r from-purple-500 to-purple-300 flex items-center justify-end pr-4"
            style="width: {{ super_rare_percentage }}%"
          >
            <span class="text-xs font-bold text-white">{{ super_rare_percentage }}%</span>
          </div>
        </div>
      </div>
      
      <div>
        <div class="flex justify-between items-center mb-2">
          <span class="text-xl font-bold text-purple-400">RARE</span>
          <span class="text-sm text-gray-600">{{ rare_count }} items</span>
        </div>
        <div class="h-8 bg-purple-100 rounded-full overflow-hidden">
          <div 
            class="rarity-bar h-full bg-gradient-to-r from-purple-400 to-purple-200 flex items-center justify-end pr-4"
            style="width: {{ rare_percentage }}%"
          >
            <span class="text-xs font-bold text-white">{{ rare_percentage }}%</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  if (typeof gsap !== 'undefined') {
    gsap.registerPlugin(ScrollTrigger);
    
    ScrollTrigger.create({
      trigger: ".rarity-bar",
      start: "top 80%",
      onEnter: () => {
        gsap.to(".rarity-bar", {
          width: "100%",
          duration: 1.5,
          ease: "power2.out",
          stagger: 0.2
        });
      }
    });
  }
</script>

{% schema %}
{
  "name": "Rarity Chart",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "RARITY"
    },
    {
      "type": "text",
      "id": "heading_accent",
      "label": "Heading Accent",
      "default": "CHART"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    }
  ],
  "presets": [
    {
      "name": "Rarity Chart"
    }
  ]
}
{% endschema %}

